{"status":{},"contains_secrets":false,"product_version":"3.1.1","spec":{"description":"basic MongoDB Cluster","resources":{"client_attrs":{"e89cd96c_deployment":{"y":343.5,"x":235},"1ab92468-9726-011e-6301-ba07252f34e6":{"y":343.5,"x":235}},"service_definition_list":[{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Mongo"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Configuration"}],"name":"b533df71_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Mongo"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Configuration","attrs":{"exit_status":[],"script":"#! \/bin\/bash\nset -ex\n\n## Variables\nDATA_IP_LIST=\"@@{dataset_data_ips}@@\"\nREPLICA_IPS=\"@@{dataset_data_ips}@@\"\nreplicaSetName=\"@@{replSetName}@@\"\nINTERNAL_IP=\"@@{address}@@\"\n\n## Evalaute extra vars \nINDEX=@@{calm_array_index}@@\nNODES_PER_REPLICA_SET=@@{NODES_PER_REPLICA_SET}@@\nARRAY_REPLICA_IPS=$(echo ${REPLICA_IPS} | sed 's\/^,\/\/' | sed 's\/,$\/\/' | tr \",\" \"\\n\")\n\ntmp=$((${INDEX}+${NODES_PER_REPLICA_SET}))\nreplicasetNo=$((${tmp}\/${NODES_PER_REPLICA_SET}))\n\n## Getting replicaset members details \nreplica_cnt=0\ndeclare -a replicaset_members\n\nfor replica in $ARRAY_REPLICA_IPS\ndo\n  tmp=$((${replica_cnt}+${NODES_PER_REPLICA_SET}))\n  i=\"$((${tmp}\/${NODES_PER_REPLICA_SET}))\"\n  replicaset_members[$i]=${replicaset_members[$i]}\"{\\\"_id\\\": $replica_cnt, host:\\\"$replica:27017\\\"},\"\n  replica_cnt=$(($replica_cnt + 1))\ndone\n\n## Tuning VM\nif [[ -f \/sys\/kernel\/mm\/transparent_hugepage\/enabled ]];then\n\techo never | sudo tee \/sys\/kernel\/mm\/transparent_hugepage\/enabled\nfi\nif [[ -f \/sys\/kernel\/mm\/transparent_hugepage\/defrag ]];then\n\techo never | sudo tee \/sys\/kernel\/mm\/transparent_hugepage\/defrag\nfi\n\nsudo sysctl vm.swappiness=1\necho 'vm.swappiness=1' | sudo tee -a \/etc\/sysctl.conf\necho \"mongod soft nproc 32000\" | sudo tee -a \"\/etc\/security\/limits.d\/20-nproc.conf\"\n\n##MongoDB Config\nsudo sed -i 's\/bindIp: 127.0.0.1\/bindIp: 0.0.0.0\/g' \/etc\/mongod.conf\nsudo sed -i \"s\/#replication:\/replication:\\n  replSetName: $replicaSetName\/g\" \/etc\/mongod.conf\n\n\nsudo systemctl enable mongod\nsudo systemctl restart mongod\n\nsleep 20\n\n### Initiating replicaset \njson=$(cat <<EOF\n{\n  \"_id\": \"$replicaSetName\",\n  \"members\": [ ${replicaset_members[$replicasetNo]}]\n}\nEOF\n)\nsudo mongo --host ${INTERNAL_IP} --port 27017 --eval \"rs.initiate( $json )\"\nsleep 5\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"cred_psdadmin"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"6019bc99_runbook","main_task_local_reference":{"kind":"app_task","name":"b533df71_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Mongo"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"a276e776_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"56f7e058_runbook","main_task_local_reference":{"kind":"app_task","name":"a276e776_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Mongo"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Start MongoDB"}],"name":"d3e9e9e2_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Mongo"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Start MongoDB","attrs":{"exit_status":[],"script":"#!\/bin\/bash\nset -ex\nsudo systemctl start mongod","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"cred_psdadmin"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"22bdeed6_runbook","main_task_local_reference":{"kind":"app_task","name":"d3e9e9e2_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Mongo"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Stop MongoDB"}],"name":"1a33593c_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Mongo"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Stop MongoDB","attrs":{"exit_status":[],"script":"#!\/bin\/bash\nset -ex\nsudo systemctl stop mongod","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"cred_psdadmin"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"f27353a0_runbook","main_task_local_reference":{"kind":"app_task","name":"1a33593c_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Mongo"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Restart MongoDB"}],"name":"e495de88_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Mongo"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Restart MongoDB","attrs":{"exit_status":[],"script":"#!\/bin\/bash\nset -ex\nsudo systemctl restart mongod","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"cred_psdadmin"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"698aed60_runbook","main_task_local_reference":{"kind":"app_task","name":"e495de88_dag"},"variable_list":[]},"name":"action_restart"}],"depends_on_list":[],"name":"Mongo","port_list":[],"tier":"","variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"dataset_data_ips","value":"","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"replSetName","value":"","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}}],"description":""}],"substrate_definition_list":[{"description":"","action_list":[{"description":"","type":"fragment","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_substrate","name":"Primary"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Set replSetName"}],"name":"3812a745_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_substrate","name":"Primary"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Set replSetName","attrs":{"exit_status":[],"script":"print(\"replSetName=nx-@@{ENV}@@-mongodb-@@{calm_minute}@@\")","eval_variables":["replSetName"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]}],"description":"","name":"9427230f_runbook","main_task_local_reference":{"kind":"app_task","name":"3812a745_dag"},"variable_list":[]},"name":"pre_action_create"},{"description":"","type":"fragment","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_substrate","name":"Primary"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"f192719a_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"dee8d110_runbook","main_task_local_reference":{"kind":"app_task","name":"f192719a_dag"},"variable_list":[]},"name":"post_action_delete"}],"type":"AHV_VM","name":"Primary","readiness_probe":{"connection_type":"SSH","retries":"5","connection_protocol":"","connection_port":22,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"60","disable_readiness_probe":false,"login_credential_local_reference":{"kind":"app_credential","name":"cred_psdadmin"}},"editables":{"create_spec":{"resources":{"nic_list":{},"serial_port_list":{}}}},"os_type":"Linux","create_spec":{"name":"psdassets-@@{ENV}@@-mongodb-@@{calm_second}@@@@{calm_unique}@@","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"9ca399e5-7f75-4d0a-953a-5b899d8d6ef8"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":4,"num_sockets":2,"gpu_list":[],"memory_size_mib":16384,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":null,"power_state":"ON","type":"","account_uuid":"037d836e-483d-4350-abda-616ba055c3ac","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"type":"","boot_type":"","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"image","type":"","name":"C7-BASE-PSDADMIN","uuid":"5fce2f91-7738-4743-8363-aaca7bf77a27"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}},{"data_source_reference":null,"type":"","disk_size_mib":204800,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":1,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":""},"variable_list":[]}],"credential_definition_list":[{"username":"psdadmin","description":"","type":"KEY","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"cred_psdadmin"}],"package_definition_list":[{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"Mongo"}],"name":"Package1","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Package1"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"set hostname"},{"kind":"app_task","name":"Volume Group"},{"kind":"app_task","name":"Intall Pre Reqs"},{"kind":"app_task","name":"Install Mongo"},{"kind":"app_task","name":"Set Variables"}],"name":"87d1dbbe_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"set hostname"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Volume Group"}},{"from_task_reference":{"kind":"app_task","name":"Volume Group"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Intall Pre Reqs"}},{"from_task_reference":{"kind":"app_task","name":"Intall Pre Reqs"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Install Mongo"}},{"from_task_reference":{"kind":"app_task","name":"Install Mongo"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Set Variables"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Mongo"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"set hostname","attrs":{"script":"#!\/bin\/bash\nset -ex\n\nsudo hostnamectl set-hostname --static @@{name}@@.churchofjesuschrist.org\n","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Mongo"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Volume Group","attrs":{"script":"#!\/bin\/bash\nset -ex\nAPPLICATION=\"mongo\"\nsudo mkdir -p \/var\/lib\/${APPLICATION}\nsudo pvcreate \/dev\/sdb\nsudo vgcreate ${APPLICATION}_vg \/dev\/sdb\nsleep 3\nsudo lvcreate -l 100%VG -n ${APPLICATION}_lvm ${APPLICATION}_vg\nsudo mkfs.xfs \/dev\/${APPLICATION}_vg\/${APPLICATION}_lvm\necho -e \"\/dev\/${APPLICATION}_vg\/${APPLICATION}_lvm \\t \/var\/lib\/${APPLICATION} \\t xfs \\t defaults \\t 0 0\" | sudo tee -a \/etc\/fstab\nsudo mount -a","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Mongo"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Intall Pre Reqs","attrs":{"script":"#!\/bin\/bash\nset -ex\n# installing EPEL - and housekeeping for PSD Group\n# 'reset' the epel repository\nsudo rm -f \/etc\/yum.repos.d\/epel.repo\nsudo yum install -y wget\necho '[epel]\nname=Extra Packages for Enterprise Linux 7 - $basearch\n#baseurl=http:\/\/download.fedoraproject.org\/pub\/epel\/7\/$basearch\nmetalink=https:\/\/mirrors.fedoraproject.org\/metalink?repo=epel-7&arch=$basearch&infra=$infra&content=$contentdir\nfailovermethod=priority\nenabled=1\ngpgcheck=1\ngpgkey=file:\/\/\/etc\/pki\/rpm-gpg\/RPM-GPG-KEY-EPEL-7\n \n[epel-debuginfo]\nname=Extra Packages for Enterprise Linux 7 - $basearch - Debug\n#baseurl=http:\/\/download.fedoraproject.org\/pub\/epel\/7\/$basearch\/debug\nmetalink=https:\/\/mirrors.fedoraproject.org\/metalink?repo=epel-debug-7&arch=$basearch&infra=$infra&content=$contentdir\nfailovermethod=priority\nenabled=0\ngpgkey=file:\/\/\/etc\/pki\/rpm-gpg\/RPM-GPG-KEY-EPEL-7\ngpgcheck=1\n \n[epel-source]\nname=Extra Packages for Enterprise Linux 7 - $basearch - Source\n#baseurl=http:\/\/download.fedoraproject.org\/pub\/epel\/7\/SRPMS\nmetalink=https:\/\/mirrors.fedoraproject.org\/metalink?repo=epel-source-7&arch=$basearch&infra=$infra&content=$contentdir\nfailovermethod=priority\nenabled=0\ngpgkey=file:\/\/\/etc\/pki\/rpm-gpg\/RPM-GPG-KEY-EPEL-7\ngpgcheck=1' | sudo tee \/etc\/yum.repos.d\/epel.repo\n \n# setup epel-release\n\nwget https:\/\/dl.fedoraproject.org\/pub\/epel\/epel-release-latest-7.noarch.rpm\nsudo yum install epel-release-latest-7.noarch.rpm -y\n \n# install tools\\pre-reqs\nsudo yum clean all\nsudo yum install -y lvm2\nsudo yum install -y  wget xfs* bc unzip lvm2* lsscsi numactl","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Mongo"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Install Mongo","attrs":{"exit_status":[],"script":"#!\/bin\/bash\nset -ex\necho '[MongoDB]\nname=MongoDB Repository\nbaseurl=http:\/\/repo.mongodb.org\/yum\/redhat\/$releasever\/mongodb-org\/4.2\/$basearch\/\ngpgcheck=1\nenabled=1\ngpgkey=https:\/\/www.mongodb.org\/static\/pgp\/server-4.2.asc' | sudo tee -a \/etc\/yum.repos.d\/mongodb.repo\n\nsudo yum install -y mongodb-org-4.2.13-1.el7","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"cred_psdadmin"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Mongo"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Set Variables","attrs":{"exit_status":[],"script":"print(\"dataset_data_ips=@@{calm_array_address}@@\")\n","eval_variables":["dataset_data_ips"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]}],"description":"","name":"b33868e8_runbook","main_task_local_reference":{"kind":"app_task","name":"87d1dbbe_dag"},"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Package1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"279757e6_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"de5e9f05_runbook","main_task_local_reference":{"kind":"app_task","name":"279757e6_dag"},"variable_list":[]}},"variable_list":[]}],"app_profile_list":[{"deployment_create_list":[{"type":"GREENFIELD","action_list":[],"name":"e89cd96c_deployment","min_replicas":"3","default_replicas":"3","depends_on_list":[],"published_service_local_reference_list":[],"max_replicas":"7","package_local_reference_list":[{"kind":"app_package","name":"Package1"}],"substrate_local_reference":{"kind":"app_substrate","name":"Primary"},"variable_list":[],"description":""}],"description":"","action_list":[{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Scale Out"}],"name":"0386dd0d_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_blueprint_deployment","name":"e89cd96c_deployment"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Scale Out","attrs":{"scaling_count":"@@{NODES_PER_REPLICA_SET}@@","type":"","scaling_type":"SCALEOUT"},"timeout_secs":"0","type":"SCALING","variable_list":[]}],"description":"","name":"1b679d81_runbook","main_task_local_reference":{"kind":"app_task","name":"0386dd0d_dag"},"variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"NODES_PER_REPLICA_SET","value":"1","label":"Enter number of nodes to scale by","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}}]},"name":"Scale_Out"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Scale In"}],"name":"2b7a86d9_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_blueprint_deployment","name":"e89cd96c_deployment"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Scale In","attrs":{"scaling_count":"1","type":"","scaling_type":"SCALEIN"},"timeout_secs":"0","type":"SCALING","variable_list":[]}],"description":"","name":"67162b9d_runbook","main_task_local_reference":{"kind":"app_task","name":"2b7a86d9_dag"},"variable_list":[]},"name":"Scale_In"}],"name":"AHV","variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"ENV","value":"prod","label":"Select the Environment","attrs":{"type":"LOCAL"},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":["prod","stage","test","dev"]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"NODES_PER_REPLICA_SET","value":"3","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}}]}],"published_service_definition_list":[],"default_credential_local_reference":{"kind":"app_credential","name":"cred_psdadmin"},"type":"USER"},"name":"MongoDB_day2"},"api_version":"3.0","metadata":{"last_update_time":"1619729014124714","kind":"blueprint","spec_version":9,"creation_time":"1619727086994843","name":"MongoDB_day2"}}