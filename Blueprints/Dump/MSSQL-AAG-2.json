{"status":{},"product_version":"2.7.1.2","spec":{"description":"","resources":{"client_attrs":{"None":{"y":300,"x":800},"MSSQL_NODE2":{"y":100,"x":700},"MSSQL_NODE1":{"y":100,"x":380}},"service_definition_list":[{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"MSSQL_NODE1"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Set Hostname Domain"},{"kind":"app_task","name":"Sleep"},{"kind":"app_task","name":"Create_VG"},{"kind":"app_task","name":"Attach_VG"},{"kind":"app_task","name":"Connect_Mount_VG"},{"kind":"app_task","name":"InstallFailOverrole"},{"kind":"app_task","name":"EnableLocalMode"},{"kind":"app_task","name":"Config_WSFC"},{"kind":"app_task","name":"InstallSQL NODE1"},{"kind":"app_task","name":"InstallSQL NODE2"},{"kind":"app_task","name":"CreateAG"}],"name":"eaf0a900_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"InstallSQL NODE1"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"InstallSQL NODE2"}},{"from_task_reference":{"kind":"app_task","name":"InstallSQL NODE2"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"CreateAG"}},{"from_task_reference":{"kind":"app_task","name":"Set Hostname Domain"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Sleep"}},{"from_task_reference":{"kind":"app_task","name":"Sleep"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Create_VG"}},{"from_task_reference":{"kind":"app_task","name":"Create_VG"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Attach_VG"}},{"from_task_reference":{"kind":"app_task","name":"Attach_VG"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Connect_Mount_VG"}},{"from_task_reference":{"kind":"app_task","name":"Connect_Mount_VG"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"InstallFailOverrole"}},{"from_task_reference":{"kind":"app_task","name":"InstallFailOverrole"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"EnableLocalMode"}},{"from_task_reference":{"kind":"app_task","name":"EnableLocalMode"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Config_WSFC"}},{"from_task_reference":{"kind":"app_task","name":"Config_WSFC"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"InstallSQL NODE1"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MSSQL_NODE1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Set Hostname Domain","attrs":{"script":"##############################################\n# Name        : JoinDomain.ps1\n# Author      : K Sarat Kumar\n# Version     : 1.0\n# Description : Script is used to Change hostname of machines and join to domain.\n##############################################\n$HOSTNAME = \"@@{name}@@-@@{calm_random}@@\"\n\nfunction Set-Hostname{\n  [CmdletBinding()]\n  Param(\n      [parameter(Mandatory=$true)]\n      [string]$Hostname\n)\n  if ($Hostname -eq  $(hostname)){\n    Write-Host \"Hostname already set.\"\n  } else{\n    Rename-Computer -NewName $HOSTNAME -ErrorAction Stop\n  }\n}\n\nfunction JointoDomain {\n  [CmdletBinding()]\n  Param(\n      [parameter(Mandatory=$true)]\n      [string]$DomainName,\n      [parameter(Mandatory=$false)]\n      [string]$OU,\n      [parameter(Mandatory=$true)]\n      [string]$Username,\n      [parameter(Mandatory=$true)]\n      [string]$Password,\n      [parameter(Mandatory=$true)]\n      [string]$Server\n  )\n  $adapter = Get-NetAdapter | ? {$_.Status -eq \"up\"}\n  $adapter | Set-DnsClientServerAddress -ServerAddresses $Server\n\n  if ($env:computername  -eq $env:userdomain) {\n    Write-Host \"Not in domain\"\n    $adminname = \"$DomainName\\$Username\"\n    $adminpassword = ConvertTo-SecureString -asPlainText -Force -String \"$Password\"\n    Write-Host \"$adminname , $password\"\n    $credential = New-Object System.Management.Automation.PSCredential($adminname,$adminpassword)\n    Add-computer -DomainName $DomainName -Credential $credential -force -Options JoinWithNewName,AccountCreate -PassThru -ErrorAction Stop\n  } else {\n     Write-Host \"Already in domain\"\n  }\n}\n\nif ($HOSTNAME -ne $Null){\n  Write-Host \"Setting Hostname\"\n  Set-Hostname -Hostname $HOSTNAME\n}\n\nJointoDomain -DomainName \"@@{DOMAIN}@@\" -Username \"@@{DOMAIN_CRED.username}@@\" -Password \"@@{DOMAIN_CRED.secret}@@\" -Server \"@@{AD_IP}@@\"\n\nRestart-Computer -Force -AsJob\nexit 0\n","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MSSQL_NODE1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Sleep","attrs":{"script":"#script\nsleep(30)","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MSSQL_NODE1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Create_VG","attrs":{"script":"$PrismIP = \"@@{PE_IP}@@\"\n$PrismUser = \"@@{PE_CREDS.username}@@\"\n$PrismPass = \"@@{PE_CREDS.secret}@@\"\n\nadd-type @\"\n    using System.Net;\n    using System.Security.Cryptography.X509Certificates;\n    public class TrustAllCertsPolicy : ICertificatePolicy {\n        public bool CheckValidationResult(\n            ServicePoint srvPoint, X509Certificate certificate,\n            WebRequest request, int certificateProblem) {\n            return true;\n        }\n    }\n\"@\n[System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy\n\n[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12\n\n$BaseURL = \"https:\/\/\" + $PrismIP + \":9440\/PrismGateway\/services\/rest\/v2.0\/\"\n$Header = @{\"Authorization\" = \"Basic \"+[System.Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes($PrismUser+\":\"+$PrismPass))}\n$Type = \"application\/json\"\n\n$VolumeGroupURL = $BaseURL+\"volume_groups\"\n$ContainerURL = $BaseURL+\"storage_containers\"\n\n$ContainerList = invoke-RestMethod -Uri $ContainerURL -Method Get -TimeoutSec 100 -Headers $Header -ContentType $Type\n$ContainerUUID = $ContainerList.entities | where { $_.name -eq \"@@{Nutanix_Container_Name}@@\"} | select storage_container_uuid\n$ContainerUUID = $ContainerUUID.storage_container_uuid\n\n$Body = @\"\n{\n  \"disk_list\": [\n    {\n      \"create_config\": {\n        \"size\": 1073741824,\n\t\"storage_container_uuid\": \"$ContainerUUID\"\n      },\n      \"index\": 0\n    }\n  ],\n  \"is_shared\": true,\n  \"name\": \"@@{Volume_GroupName}@@\"\n}\n\"@\n\nInvoke-RestMethod -Uri $VolumeGroupURL -Method Post -TimeoutSec 100 -Headers $Header -ContentType $Type -Body $Body\n","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MSSQL_NODE1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Attach_VG","attrs":{"script":"$MsSQL1_iSCSI_IQN = (Get-InitiatorPort).NodeAddress\n\n$PrismIP = \"@@{PE_IP}@@\"\n$PrismUser = \"@@{PE_CREDS.username}@@\"\n$PrismPass = \"@@{PE_CREDS.secret}@@\"\n\nadd-type @\"\n    using System.Net;\n    using System.Security.Cryptography.X509Certificates;\n    public class TrustAllCertsPolicy : ICertificatePolicy {\n        public bool CheckValidationResult(\n            ServicePoint srvPoint, X509Certificate certificate,\n            WebRequest request, int certificateProblem) {\n            return true;\n        }\n    }\n\"@\n[System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy\n\n[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12\n\n$BaseURL = \"https:\/\/\" + $PrismIP + \":9440\/PrismGateway\/services\/rest\/v2.0\/\"\n$Header = @{\"Authorization\" = \"Basic \"+[System.Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes($PrismUser+\":\"+$PrismPass))}\n$Type = \"application\/json\"\n\n$VolumeGroupURL = $BaseURL+\"volume_groups\"\n\n$VolumeGroupList = invoke-RestMethod -Uri $VolumeGroupURL -Method Get -TimeoutSec 100 -Headers $Header -ContentType $Type\n$VolumeGroupUUID = $VolumeGroupList.entities | where { $_.name -eq \"@@{Volume_GroupName}@@\"} | select uuid\n$VolumeGroupUUID = $VolumeGroupUUID.uuid\n\n$VolumeGroupAttachURL = $VolumeGroupURL+\"\/$VolumeGroupUUID\"+\"\/open\"\n\n$Body = @\"\n{\n  \"iscsi_client\": {\n    \"client_address\": \"$MsSQL1_iSCSI_IQN\"\n  },\n  \"operation\": \"ATTACH\"\n}\n\"@\n\nInvoke-RestMethod -Uri $VolumeGroupAttachURL -Method Post -TimeoutSec 100 -Headers $Header -ContentType $Type -Body $Body\n\nsleep 5","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MSSQL_NODE1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Connect_Mount_VG","attrs":{"script":"New-IscsiTargetPortal -TargetPortalAddress @@{PE_DATA_SERVICE_IP}@@\nGet-IscsiTarget | Connect-IscsiTarget -IsPersistent $true\n\n\n#Initialize Disks\nGet-Disk -Number 1 | Initialize-Disk -ErrorAction SilentlyContinue\nGet-Disk -Number 2 | Initialize-Disk -ErrorAction SilentlyContinue\nGet-Disk -Number 3 | Initialize-Disk -ErrorAction SilentlyContinue\n\nNew-Partition -DiskNumber 1 -UseMaximumSize -DriveLetter E -ErrorAction SilentlyContinue | Format-Volume -Confirm:$false -FileSystem NTFS -NewFileSystemLabel \"Data\" \nNew-Partition -DiskNumber 2 -UseMaximumSize -DriveLetter F -ErrorAction SilentlyContinue | Format-Volume -Confirm:$false -FileSystem NTFS -NewFileSystemLabel \"Logs\" \nNew-Partition -DiskNumber 3 -UseMaximumSize -DriveLetter G -ErrorAction SilentlyContinue | Format-Volume -Confirm:$false -FileSystem NTFS -NewFileSystemLabel \"Witness\" \n\n\n#Format Witness Disk\n#foreach ($disk in get-disk){\n#$disksize = ($disk).size\n#if (($disksize \/1024 \/1024 \/1024) -eq 1){\n#  New-Partition -DiskNumber ($disk).Number -UseMaximumSize -DriveLetter E -ErrorAction SilentlyContinue | Format-Volume -Confirm:$false -FileSystem NTFS -NewFileSystemLabel \"Witness\" }\n#}\n\n#Format Data Disk\n#foreach ($disk in get-disk){\n#$disksize = ($disk).size\n#if (($disksize \/1024 \/1024 \/1024) -eq @@{DB_Disk_Size_GB}@@){\n#  New-Partition -DiskNumber ($disk).Number -UseMaximumSize -DriveLetter F -ErrorAction SilentlyContinue | Format-Volume -Confirm:$false -FileSystem NTFS -NewFileSystemLabel \"Data\" }\n#}\n\n#Format Logs Disk\n#foreach ($disk in get-disk){\n#$disksize = ($disk).size\n#if (($disksize \/1024 \/1024 \/1024) -eq @@{Log_Disk_Size_GB}@@){\n#  New-Partition -DiskNumber ($disk).Number -UseMaximumSize -DriveLetter G -ErrorAction SilentlyContinue | Format-Volume -Confirm:$false -FileSystem NTFS -NewFileSystemLabel \"Logs\" }\n#}","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MSSQL_NODE1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"InstallFailOverrole","attrs":{"script":"Install-WindowsFeature -Name Failover-Clustering -IncludeManagementTools","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MSSQL_NODE1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"EnableLocalMode","attrs":{"exit_status":[],"script":"#script\nprint \"EXECUTION_MODE=LOCAL\"","eval_variables":["EXECUTION_MODE"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MSSQL_NODE1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Config_WSFC","attrs":{"script":"$adminname=\"@@{DOMAIN_CRED.username}@@\"\n$adminpassword = ConvertTo-SecureString -asPlainText -Force -String \"@@{DOMAIN_CRED.secret}@@\"\n$credential = New-Object System.Management.Automation.PSCredential($adminname,$adminpassword)\n\nwhile ((Get-WindowsFeature -ComputerName @@{MSSQL2.address}@@ -Name Failover-Clustering | select -ExpandProperty InstallState) -ne \"Installed\") {sleep 10}\n\n$testScript = {\n\t$Nodes=\"@@{address}@@,@@{MSSQL2.address}@@\".split(',')\n    if(Test-Cluster -Node $Nodes){\n        Return $True\n    }\n    else\n    {\n        Return $False\n    }\n} \n\n$TestStatus = Invoke-Command -ComputerName @@{address}@@ -Credential $credential -Authentication Credssp $testScript\n\nif ($TestStatus -eq $false){\nWrite-Output \"Failed\"\nExit 1\n}\n\n$ClusterCreate = {\n    #Import-Module FailoverClusters\n    $Nodes=\"@@{address}@@,@@{MSSQL2.address}@@\".split(',')\n    New-Cluster -Name @@{FAILOVER_CLUSTER_NAME}@@ -Node $Nodes -StaticAddress @@{FAILOVER_VIP}@@\n} \n\n$ClusterStatus = Invoke-Command -ComputerName @@{address}@@ -Credential $credential -Authentication Credssp $ClusterCreate\n\nif (!$ClusterStatus.Name){\n    Write-Output \"Failed creating CLuster\"\n}\n\n$RenameClusterDisks = {\n    #Rename Cluster Disks\n    $ClusterDisks =  Get-CimInstance -ClassName MSCluster_Resource -Namespace root\/mscluster -Filter \"type = 'Physical Disk'\"\n    foreach ($Disk in $ClusterDisks) {\n    $DiskResource = Get-CimAssociatedInstance -InputObject $Disk -ResultClass MSCluster_DiskPartition\n        if (-not ($DiskResource.VolumeLabel -eq $Disk.Name)) {\n        Invoke-CimMethod -InputObject $Disk -MethodName Rename -Arguments @{newName = $DiskResource.VolumeLabel}\n        }\n    }\n} \n\nInvoke-Command -ComputerName @@{address}@@ -Credential $credential -Authentication Credssp $RenameClusterDisks","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MSSQL_NODE1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"InstallSQL NODE1","attrs":{"script":"$Script = {\n\n    Install-WindowsFeature -IncludeAllSubFeature -ErrorAction Stop \"Net-Framework-Core\"\n    $DOMAINNAME=(Get-WmiObject Win32_ComputerSystem).Domain\n    $setupDriveLetter = \"D:\"\n    $setupPath = \"$setupDriveLetter\\setup.exe\"\n    $silentArgs = \"\/IACCEPTSQLSERVERLICENSETERMS \/Q \/ACTION=install \/FEATURES=SQLENGINE,REPLICATION,FULLTEXT,DQ,AS,RS,RS_SHP,RS_SHPWFE,DQC,CONN,IS,BC,SDK,BOL,SSMS,ADV_SSMS,DREPLAY_CTLR,DREPLAY_CLT,SNAC_SDK,MDS \/AGTSVCACCOUNT=`\"@@{SQL_CREDS.username}@@`\" \/AGTSVCPASSWORD=@@{SQL_CREDS.secret}@@ \/SQLSVCACCOUNT=`\"@@{SQL_CREDS.username}@@`\" \/SQLSVCPASSWORD=@@{SQL_CREDS.secret}@@ \/SQLSYSADMINACCOUNTS=`\"$DOMAINNAME\\Domain Admins`\" \/ISSVCACCOUNT=`\"@@{SQL_CREDS.username}@@`\" \/ISSVCPASSWORD=@@{SQL_CREDS.secret}@@ \/ASSYSADMINACCOUNTS=`\"@@{SQL_CREDS.username}@@`\" \/INSTANCEID=MSSQLSERVER \/INSTANCENAME=MSSQLSERVER \/UPDATEENABLED=False \/INDICATEPROGRESS \/TCPENABLED=1 \/INSTALLSQLDATADIR=`\"E:\\MSSQL`\" \/SQLUSERDBLOGDIR=`\"F:\\MSSQL`\" \/SQLTEMPDBLOGDIR=`\"F:\\MSSQL`\"\"\n    $validExitCodes = @(0)\n\n    $install = Start-Process -FilePath $setupPath -ArgumentList $silentArgs -Wait -NoNewWindow -PassThru\n    $install.WaitForExit()\n    $exitCode = $install.ExitCode\n    $install.Dispose()\n    \n    Write-Output \"SQL Failover Cluster Installation exited with `'$exitCode`'.\"\n      if ($validExitCodes -notcontains $exitCode) {\n          Write-Output \"Running [`\"$setupPath`\" $silentArgs] was not successful. Exit code was '$exitCode'. See log for possible error messages.\"\n\n    }\n\n}\n\n$adminpassword = ConvertTo-SecureString -asPlainText -Force -String \"@@{DOMAIN_CRED.secret}@@\"\n$Creds = New-Object System.Management.Automation.PSCredential(\"@@{DOMAIN_CRED.username}@@\",$adminpassword)\n\nInvoke-Command -ComputerName @@{address}@@ -Credential $Creds -ScriptBlock $Script -Authentication Credssp\n","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MSSQL_NODE1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"InstallSQL NODE2","attrs":{"script":"$Script = {\n\n    Install-WindowsFeature -IncludeAllSubFeature -ErrorAction Stop \"Net-Framework-Core\"\n    $DOMAINNAME=(Get-WmiObject Win32_ComputerSystem).Domain\n    $setupDriveLetter = \"D:\"\n    $setupPath = \"$setupDriveLetter\\setup.exe\"\n    $silentArgs = \"\/IACCEPTSQLSERVERLICENSETERMS \/Q \/ACTION=install \/FEATURES=SQLENGINE,REPLICATION,FULLTEXT,DQ,AS,RS,RS_SHP,RS_SHPWFE,DQC,CONN,IS,BC,SDK,BOL,SSMS,ADV_SSMS,DREPLAY_CTLR,DREPLAY_CLT,SNAC_SDK,MDS \/AGTSVCACCOUNT=`\"@@{SQL_CREDS.username}@@`\" \/AGTSVCPASSWORD=@@{SQL_CREDS.secret}@@ \/SQLSVCACCOUNT=`\"@@{SQL_CREDS.username}@@`\" \/SQLSVCPASSWORD=@@{SQL_CREDS.secret}@@ \/SQLSYSADMINACCOUNTS=`\"$DOMAINNAME\\Domain Admins`\" \/ISSVCACCOUNT=`\"@@{SQL_CREDS.username}@@`\" \/ISSVCPASSWORD=@@{SQL_CREDS.secret}@@ \/ASSYSADMINACCOUNTS=`\"@@{SQL_CREDS.username}@@`\" \/INSTANCEID=MSSQLSERVER \/INSTANCENAME=MSSQLSERVER \/UPDATEENABLED=False \/INDICATEPROGRESS \/TCPENABLED=1 \/INSTALLSQLDATADIR=`\"E:\\MSSQL`\" \/SQLUSERDBLOGDIR=`\"F:\\MSSQL`\" \/SQLTEMPDBLOGDIR=`\"F:\\MSSQL`\"\"\n    $validExitCodes = @(0)\n\n    $install = Start-Process -FilePath $setupPath -ArgumentList $silentArgs -Wait -NoNewWindow -PassThru\n    $install.WaitForExit()\n    $exitCode = $install.ExitCode\n    $install.Dispose()\n    \n    Write-Output \"SQL Failover Cluster Installation exited with `'$exitCode`'.\"\n      if ($validExitCodes -notcontains $exitCode) {\n          Write-Output \"Running [`\"$setupPath`\" $silentArgs] was not successful. Exit code was '$exitCode'. See log for possible error messages.\"\n\n    }\n\n}\n\n$adminpassword = ConvertTo-SecureString -asPlainText -Force -String \"@@{DOMAIN_CRED.secret}@@\"\n$Creds = New-Object System.Management.Automation.PSCredential(\"@@{DOMAIN_CRED.username}@@\",$adminpassword)\n\nInvoke-Command -ComputerName @@{MSSQL2.address}@@ -Credential $Creds -ScriptBlock $Script -Authentication Credssp\n","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MSSQL_NODE1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"CreateAG","attrs":{"script":"$Script = {\n\n#Import-Module SQLPS -DisableNameCheckin\n$AGName = '@@{SQL_CLUSTER_NAME}@@'\n$PrimaryNode = $(hostname)\n$IP = '@@{MSSQL_VIP}@@\/255.255.255.0'\n$replicas = @()\n\n$cname = (Get-Cluster -name $PrimaryNode).name\n$nodes = (get-clusternode -Cluster $cname).name\n\n$sqlperms = @\"\nuse [master];\nGRANT ALTER ANY AVAILABILITY GROUP TO [NT AUTHORITY\\SYSTEM];\nGRANT CONNECT SQL TO [NT AUTHORITY\\SYSTEM];\nGRANT VIEW SERVER STATE TO [NT AUTHORITY\\SYSTEM];\n\"@\n\nforeach($node in $nodes){\n    Enable-SqlAlwaysOn -Path \"SQLSERVER:\\SQL\\$node\\DEFAULT\" -Force\n    Invoke-Sqlcmd -ServerInstance $node -Database master -Query $sqlperms\n    $replicas += New-SqlAvailabilityReplica -Name $node -EndpointUrl \"TCP:\/\/$($node):5022\" -AvailabilityMode 'SynchronousCommit' -FailoverMode 'Automatic' -AsTemplate -Version 12\n}\n\nNew-SqlAvailabilityGroup -Name $AGName -Path \"SQLSERVER:\\SQL\\$PrimaryNode\\DEFAULT\" -AvailabilityReplica $replicas\n\n$nodes | Where-Object {$_ -ne $PrimaryNode} | ForEach-Object {Join-SqlAvailabilityGroup -path \"SQLSERVER:\\SQL\\$_\\DEFAULT\" -Name $AGName}\n\nNew-SqlAvailabilityGroupListener -Name $AGName -staticIP $IP -Port 1433 -Path \"SQLSERVER:\\Sql\\$PrimaryNode\\DEFAULT\\AvailabilityGroups\\$AGName\"\n\n}\n\n$adminpassword = ConvertTo-SecureString -asPlainText -Force -String \"@@{DOMAIN_CRED.secret}@@\"\n$Creds = New-Object System.Management.Automation.PSCredential(\"@@{DOMAIN_CRED.username}@@\",$adminpassword)\n\nInvoke-Command -ComputerName @@{address}@@ -Credential $Creds -ScriptBlock $Script -Authentication Credssp\n","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"c04c69a3_runbook","main_task_local_reference":{"kind":"app_task","name":"eaf0a900_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"MSSQL_NODE1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"8f7cf20a_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"8318cea9_runbook","main_task_local_reference":{"kind":"app_task","name":"8f7cf20a_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"MSSQL_NODE1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"5c0845b7_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"7b2ccecf_runbook","main_task_local_reference":{"kind":"app_task","name":"5c0845b7_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"MSSQL_NODE1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"97961162_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"b9b5c587_runbook","main_task_local_reference":{"kind":"app_task","name":"97961162_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"MSSQL_NODE1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"c314ffb1_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"18b6a807_runbook","main_task_local_reference":{"kind":"app_task","name":"c314ffb1_dag"},"variable_list":[]},"name":"action_restart"}],"depends_on_list":[],"name":"MSSQL_NODE1","port_list":[],"tier":"","variable_list":[],"description":""},{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"MSSQL_NODE2"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Set Hostname Domain"},{"kind":"app_task","name":"Sleep"},{"kind":"app_task","name":"Attach_VG"},{"kind":"app_task","name":"Connect_Mount_VG"},{"kind":"app_task","name":"InstallFailOverrole"}],"name":"246b5193_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Set Hostname Domain"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Sleep"}},{"from_task_reference":{"kind":"app_task","name":"Sleep"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Attach_VG"}},{"from_task_reference":{"kind":"app_task","name":"Attach_VG"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Connect_Mount_VG"}},{"from_task_reference":{"kind":"app_task","name":"Connect_Mount_VG"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"InstallFailOverrole"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MSSQL_NODE2"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Set Hostname Domain","attrs":{"script":"##############################################\n# Name        : JoinDomain.ps1\n# Author      : K Sarat Kumar\n# Version     : 1.0\n# Description : Script is used to Change hostname of machines and join to domain.\n##############################################\n$HOSTNAME = \"@@{name}@@-@@{calm_random}@@\"\n\nfunction Set-Hostname{\n  [CmdletBinding()]\n  Param(\n      [parameter(Mandatory=$true)]\n      [string]$Hostname\n)\n  if ($Hostname -eq  $(hostname)){\n    Write-Host \"Hostname already set.\"\n  } else{\n    Rename-Computer -NewName $HOSTNAME -ErrorAction Stop\n  }\n}\n\nfunction JointoDomain {\n  [CmdletBinding()]\n  Param(\n      [parameter(Mandatory=$true)]\n      [string]$DomainName,\n      [parameter(Mandatory=$false)]\n      [string]$OU,\n      [parameter(Mandatory=$true)]\n      [string]$Username,\n      [parameter(Mandatory=$true)]\n      [string]$Password,\n      [parameter(Mandatory=$true)]\n      [string]$Server\n  )\n  $adapter = Get-NetAdapter | ? {$_.Status -eq \"up\"}\n  $adapter | Set-DnsClientServerAddress -ServerAddresses $Server\n\n  if ($env:computername  -eq $env:userdomain) {\n    Write-Host \"Not in domain\"\n    $adminname = \"$DomainName\\$Username\"\n    $adminpassword = ConvertTo-SecureString -asPlainText -Force -String \"$Password\"\n    Write-Host \"$adminname , $password\"\n    $credential = New-Object System.Management.Automation.PSCredential($adminname,$adminpassword)\n    Add-computer -DomainName $DomainName -Credential $credential -force -Options JoinWithNewName,AccountCreate -PassThru -ErrorAction Stop\n  } else {\n     Write-Host \"Already in domain\"\n  }\n}\n\nif ($HOSTNAME -ne $Null){\n  Write-Host \"Setting Hostname\"\n  Set-Hostname -Hostname $HOSTNAME\n}\n\nJointoDomain -DomainName \"@@{DOMAIN}@@\" -Username \"@@{DOMAIN_CRED.username}@@\" -Password \"@@{DOMAIN_CRED.secret}@@\" -Server \"@@{AD_IP}@@\"\n\nRestart-Computer -Force -AsJob\nexit 0\n","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MSSQL_NODE2"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Sleep","attrs":{"script":"#script\nsleep(90)","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MSSQL_NODE2"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Attach_VG","attrs":{"script":"$MsSQL1_iSCSI_IQN = (Get-InitiatorPort).NodeAddress\n\n$PrismIP = \"@@{PE_IP}@@\"\n$PrismUser = \"@@{PE_CREDS.username}@@\"\n$PrismPass = \"@@{PE_CREDS.secret}@@\"\n\nadd-type @\"\n    using System.Net;\n    using System.Security.Cryptography.X509Certificates;\n    public class TrustAllCertsPolicy : ICertificatePolicy {\n        public bool CheckValidationResult(\n            ServicePoint srvPoint, X509Certificate certificate,\n            WebRequest request, int certificateProblem) {\n            return true;\n        }\n    }\n\"@\n[System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy\n\n[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12\n\n$BaseURL = \"https:\/\/\" + $PrismIP + \":9440\/PrismGateway\/services\/rest\/v2.0\/\"\n$Header = @{\"Authorization\" = \"Basic \"+[System.Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes($PrismUser+\":\"+$PrismPass))}\n$Type = \"application\/json\"\n\n$VolumeGroupURL = $BaseURL+\"volume_groups\"\n\n$VolumeGroupList = invoke-RestMethod -Uri $VolumeGroupURL -Method Get -TimeoutSec 100 -Headers $Header -ContentType $Type\n$VolumeGroupUUID = $VolumeGroupList.entities | where { $_.name -eq \"@@{Volume_GroupName}@@\"} | select uuid\n$VolumeGroupUUID = $VolumeGroupUUID.uuid\n\n$VolumeGroupAttachURL = $VolumeGroupURL+\"\/$VolumeGroupUUID\"+\"\/open\"\n\n$Body = @\"\n{\n  \"iscsi_client\": {\n    \"client_address\": \"$MsSQL1_iSCSI_IQN\"\n  },\n  \"operation\": \"ATTACH\"\n}\n\"@\n\nInvoke-RestMethod -Uri $VolumeGroupAttachURL -Method Post -TimeoutSec 100 -Headers $Header -ContentType $Type -Body $Body\n\nsleep 5","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MSSQL_NODE2"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Connect_Mount_VG","attrs":{"script":"New-IscsiTargetPortal -TargetPortalAddress @@{PE_DATA_SERVICE_IP}@@\nGet-IscsiTarget | Connect-IscsiTarget -IsPersistent $true\n\n#Initialize Disks\nGet-Disk -Number 1 | Initialize-Disk -ErrorAction SilentlyContinue\nGet-Disk -Number 2 | Initialize-Disk -ErrorAction SilentlyContinue\n\nNew-Partition -DiskNumber 1 -UseMaximumSize -DriveLetter E -ErrorAction SilentlyContinue | Format-Volume -Confirm:$false -FileSystem NTFS -NewFileSystemLabel \"Data\" \nNew-Partition -DiskNumber 2 -UseMaximumSize -DriveLetter F -ErrorAction SilentlyContinue | Format-Volume -Confirm:$false -FileSystem NTFS -NewFileSystemLabel \"Logs\" \n","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MSSQL_NODE2"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"InstallFailOverrole","attrs":{"script":"Install-WindowsFeature -Name Failover-Clustering -IncludeManagementTools ","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"021a483c_runbook","main_task_local_reference":{"kind":"app_task","name":"246b5193_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"MSSQL_NODE2"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"cdaf4ec5_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"5e87f17a_runbook","main_task_local_reference":{"kind":"app_task","name":"cdaf4ec5_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"MSSQL_NODE2"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"ad1c5978_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"437e0f5f_runbook","main_task_local_reference":{"kind":"app_task","name":"ad1c5978_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"MSSQL_NODE2"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"c93dcafa_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"f5d9fafa_runbook","main_task_local_reference":{"kind":"app_task","name":"c93dcafa_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"MSSQL_NODE2"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"501c2e02_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"edeb5158_runbook","main_task_local_reference":{"kind":"app_task","name":"501c2e02_dag"},"variable_list":[]},"name":"action_restart"}],"depends_on_list":[],"name":"MSSQL_NODE2","port_list":[],"tier":"","variable_list":[],"description":""}],"substrate_definition_list":[{"description":"","action_list":[{"description":"","type":"fragment","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_substrate","name":"MSSQL1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"3ee08a8b_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"f1d4925d_runbook","main_task_local_reference":{"kind":"app_task","name":"3ee08a8b_dag"},"variable_list":[]},"name":"pre_action_create"},{"description":"","type":"fragment","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_substrate","name":"MSSQL1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"7e3b9b9a_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"6e9c1df8_runbook","main_task_local_reference":{"kind":"app_task","name":"7e3b9b9a_dag"},"variable_list":[]},"name":"post_action_delete"}],"type":"AHV_VM","name":"MSSQL1","readiness_probe":{"connection_type":"POWERSHELL","retries":"5","disable_readiness_probe":false,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"10","connection_port":5985,"login_credential_local_reference":{"kind":"app_credential","name":"LOCAL"}},"editables":{"create_spec":{"resources":{"nic_list":{},"serial_port_list":{},"disk_list":{"2":{}}}}},"os_type":"Windows","create_spec":{"name":"MSSQL1","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"89c4632d-c481-48e1-ba35-bb920855c717"},"type":""},{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"89c4632d-c481-48e1-ba35-bb920855c717"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":1,"num_sockets":4,"gpu_list":[],"memory_size_mib":6144,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":null,"power_state":"ON","type":"","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"type":"","boot_type":"","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"image","type":"","name":"Win2019gui-1909","uuid":"81ac2d3b-33fc-45a8-8ddf-3b56774b8523"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}},{"data_source_reference":{"kind":"image","type":"","name":"SQL2017Std","uuid":"add1c915-7575-4230-97a7-b192d68020a4"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"IDE"},"device_type":"CDROM"}},{"data_source_reference":null,"type":"","disk_size_mib":204800,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":1,"adapter_type":"SCSI"},"device_type":"DISK"}},{"data_source_reference":null,"type":"","disk_size_mib":102400,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":2,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":""},"variable_list":[]},{"description":"","action_list":[],"type":"AHV_VM","name":"MSSQL2","readiness_probe":{"connection_type":"POWERSHELL","retries":"5","disable_readiness_probe":false,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"10","connection_port":5985,"login_credential_local_reference":{"kind":"app_credential","name":"LOCAL"}},"editables":{"create_spec":{"resources":{"nic_list":{},"serial_port_list":{}}}},"os_type":"Windows","create_spec":{"name":"MSSQL2","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"89c4632d-c481-48e1-ba35-bb920855c717"},"type":""},{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"89c4632d-c481-48e1-ba35-bb920855c717"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":1,"num_sockets":4,"gpu_list":[],"memory_size_mib":6144,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":null,"power_state":"ON","type":"","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"type":"","boot_type":"","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"image","type":"","name":"Win2019gui-1909","uuid":"81ac2d3b-33fc-45a8-8ddf-3b56774b8523"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}},{"data_source_reference":{"kind":"image","type":"","name":"SQL2017Std","uuid":"add1c915-7575-4230-97a7-b192d68020a4"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"IDE"},"device_type":"CDROM"}},{"data_source_reference":null,"type":"","disk_size_mib":204800,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":1,"adapter_type":"SCSI"},"device_type":"DISK"}},{"data_source_reference":null,"type":"","disk_size_mib":102400,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":2,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":""},"variable_list":[]}],"credential_definition_list":[{"username":"administrator","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"LOCAL"},{"username":"administrator@dustylane.local","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"DOMAIN_CRED"},{"username":"admin","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"PE_CREDS"},{"username":"dustylane\\administrator","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"SQL_CREDS"}],"package_definition_list":[{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"MSSQL_NODE1"}],"name":"MSSQL1Package","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"MSSQL1Package"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[{"kind":"app_task","name":"PackageInstallTask"}],"name":"54ac1af0_dag","state":"ACTIVE","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_package","name":"MSSQL1Package"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"PackageInstallTask","state":"ACTIVE","attrs":{"script":"# -*- Pre-requisite to enable credssp and set 'Server' role\nEnable-WSManCredSSP -Role Server -Force\n# -*- Enabling and starting 'msiscsi'\nSet-Service -Name msiscsi -StartupType Automatic\nStart-Service msiscsi\n# -*- Change first Ehternet adapter name to 'Production'\nGet-NetAdapter -Name \"Ethernet\" | Rename-NetAdapter -NewName \"Production\" -ErrorAction SilentlyContinue\n# -*- Create VG\n","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"2583f558_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"54ac1af0_dag"},"message_list":[],"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"MSSQL1Package"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"a0f9253d_dag","state":"ACTIVE","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"9306a897_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"a0f9253d_dag"},"message_list":[],"variable_list":[]}},"variable_list":[]},{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"MSSQL_NODE2"}],"name":"MSSQL2Package","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"MSSQL2Package"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[{"kind":"app_task","name":"PackageInstallTask"}],"name":"b58ae90e_dag","state":"ACTIVE","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_package","name":"MSSQL2Package"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"PackageInstallTask","state":"ACTIVE","attrs":{"script":"# -*- Pre-requisite to enable credssp and set 'Server' role\nEnable-WSManCredSSP -Role Server -Force\n# -*- Enabling and starting 'msiscsi'\nSet-Service -Name msiscsi -StartupType Automatic\nStart-Service msiscsi\n# -*- Change first Ehternet adapter name to 'Production'\nGet-NetAdapter -Name \"Ethernet\" | Rename-NetAdapter -NewName \"Production\" -ErrorAction SilentlyContinue\n","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"1556a280_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"b58ae90e_dag"},"message_list":[],"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"MSSQL2Package"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"08d22cd8_dag","state":"ACTIVE","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"43204baa_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"08d22cd8_dag"},"message_list":[],"variable_list":[]}},"variable_list":[]}],"app_profile_list":[{"deployment_create_list":[{"type":"GREENFIELD","action_list":[],"depends_on_list":[],"name":"cb9c05a7_deployment","published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"MSSQL1Package"}],"substrate_local_reference":{"kind":"app_substrate","name":"MSSQL1"},"min_replicas":"1","variable_list":[],"description":""},{"type":"GREENFIELD","action_list":[],"depends_on_list":[],"name":"c90370aa_deployment","published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"MSSQL2Package"}],"substrate_local_reference":{"kind":"app_substrate","name":"MSSQL2"},"min_replicas":"1","variable_list":[],"description":""}],"description":"","action_list":[],"name":"Default","variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"DOMAIN","value":"example.com","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"AD_IP","value":"10.5.73.55","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"PE_IP","value":"10.5.67.138","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"DB_Disk_Size_GB","value":"200","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"Log_Disk_Size_GB","value":"100","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"Volume_GroupName","value":"SQL_VolumeGroup01","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"Nutanix_Container_Name","value":"default-container-43360047467620","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"PE_DATA_SERVICE_IP","value":"10.5.67.143","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"FAILOVER_CLUSTER_NAME","value":"NTNX-CLS01","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"FAILOVER_VIP","value":"10.5.64.2","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"MSSQL_VIP","value":"10.5.64.3","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"SQL_CLUSTER_NAME","value":"NTNX-SQLCLS","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false}]}],"published_service_definition_list":[],"default_credential_local_reference":{"kind":"app_credential","name":"LOCAL"},"type":"USER"},"name":"MSSQL-AAG"},"api_version":"3.0","metadata":{"last_update_time":"1587749063327621","kind":"blueprint","spec_version":2,"creation_time":"1587671937202456","name":"MSSQL-AAG"}}